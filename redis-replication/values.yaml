---
redisReplication:
  name: "redis"
  clusterSize: 3
  image: docker.io/ruo91/opstree-redis-fedora
  tag: v8.0.2
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
    # - name:  Secret with Registry credentials
  redisSecret:
    secretName: "redis-secret"
    secretKey: "password"
  serviceType: ClusterIP
  resources:
    requests:
      #cpu: 8
      memory: 32Gi
      #hugepages-2Mi: "32Gi"
      #hugepages-1Gi: "32Gi"
    limits:
      #cpu: 8
      memory: 32Gi
      #hugepages-2Mi: "32Gi"
      #hugepages-1Gi: "32Gi"
  ignoreAnnotations: []
    # - "redis.opstreelabs.in/ignore"
  minReadySeconds: 0
  # -- Some fields of statefulset are immutable, such as volumeClaimTemplates.
  # When set to true, the operator will delete the statefulset and recreate it. Default is false.
  recreateStatefulSetOnUpdateInvalid: false
  # -- MaxMemoryPercentOfLimit is the percentage of the Redis container memory limit to be used as maxmemory.
  #    When a memory limit exists, the operator also exposes the computed value via the REDIS_MAX_MEMORY env var.
  #    Default is 0 (disabled).
  maxMemoryPercentOfLimit: 0
  persistentVolumeClaimRetentionPolicy: {}
    # whenDeleted: Delete
    # whenScaled: Retain

  # Enable or disable Multus CNI attachment for Redis Pods.
  # When set to true, an additional network interface (net1) will be attached to each Pod.
  multus:
    enabled: true

    # Name of the Multus NetworkAttachmentDefinition (NAD) to use.
    # This must match an existing NAD in the same namespace.
    # Only applied when 'enabled' is set to true.
    name: redis-replication-ipvlan-l2

  #livenessProbe: {}
  livenessProbe:
    timeoutSeconds: 5
    periodSeconds: 15
    successThreshold: 1
    failureThreshold: 5
    initialDelaySeconds: 15

  #readinessProbe: {}
  readinessProbe:
    timeoutSeconds: 5
    periodSeconds: 15
    successThreshold: 1
    failureThreshold: 5
    initialDelaySeconds: 15

# Overwite name for resources
# name: ""

labels: {}
#   foo: bar
#   test: echo

externalConfig:
  enabled: true
  data: |
    #### Connectio Management ####
    # Disable protected mode. DANGEROUS on a public interface.
    # Only use this when Redis is bound to private networks and/or ACL+AUTH is enforced.
    protected-mode no
    
    # Maximum number of client connections. Requires matching OS fd/ulimit tuning.
    # Very high values also require sufficient memory for client state.
    maxclients 50000
    
    # Listen backlog for pending TCP connection (subject to /proc/sys/net/core/somaxconn).
    tcp-backlog 65535
    
    # Client idle timeout in seconds; 0 = never idsconnect idle clients.
    timeout 0
    
    # TCP keepalive interval in seconds. Helps detect dead peers/NAT drops.
    tcp-keepalive 300
    
    #### Announce IP/Port (for replicas behind NAT) ####
    # use these when the master must connect back to a  replica that is not directly reachable.
    #replica-announce-ip 192.168.0.100
    #replica-announce-port 30012
    
    #### Memory Usage & Eviction ####
    # Hard cap for Redis memory. Includes data + overhead + client buffers.
    maxmemory 32gb
    
    # Evict any key (volatile or not) using LRU when memory is full.
    maxmemory-policy allkeys-lru
    
    # Number of samples checked by LRU/LFU/TTL algorithms (higher = better accuracy, more CPU).
    maxmemory-samples 10
    
    #### Performance / Timing ####
    # Server cron frequency (1..500). Higher reduces latency of periodic tasks but increases CPU.
    hz 100
    
    # Dynamically scale internal frequency based on load (uses 'hz' as the upper bound).
    # Redis 8 defaults to 'yes'. Uncommect to be explicit.
    dynamic-hz yes
    
    #### Latency tuning & Slow Log ####
    # Record operations taking >= 5 ms for analysis with LATENCY commands.
    latency-monitor-threshold 5
    
    # Log commands slower than 15 ms to the slowlog.
    slowlog-log-slower-than 15000
    # ...keeping up to 1024 entries (oldest evicted).
    slowlog-max-len 1024
    
    #### Append Only File (AOF) / RDB durability ####
    # Fsync AOF once per second (balance durability and throughput; up to ~1s data loss on crash).
    appendfsync everysec
    
    # Start AOF with an RDB preamble for faster restarts.
    aof-use-rdb-preamble yes
    
    # On startup, accept truncated AOF by discarding the corrupted tail.
    aof-load-truncated yes
    
    # Incremental fsync during AOF rewrite to smooth I/O.
    aof-rewrite-incremental-fsync yes
    
    # Incremental fsync during RDB saves to reduce latency spikes.
    rdb-save-incremental-fsync yes
    
    # Trigger automatic AOF rewrite when file size doubled since last rewrite...
    auto-aof-rewrite-percentage 100
    # ...and only if the file is at least 128 MB.
    auto-aof-rewrite-min-size 128mb
    
    #### Client Output Buffer limits ####
    # Format: <class> <hard> <soft> <soft-seconds>
    # > hard -> immediate disconnect
    # > soft for soft-seconds -> disconnect
    
    # Replicas: generous to avoid link breaks during bursts (uses RAM).
    client-output-buffer-limit replica 1024mb 512mb 120
    
    # Deprecated alias for backward compatibility (same as 'replica').
    client-output-buffer-limit slave 1024mb 512mb 120
    
    # Normal clients: balanced limits for spikes vs memory usage.
    client-output-buffer-limit normal 256mb 128mb 120
    
    # Pub/Sub clients: tighter limits to prevent fan-out blowups.
    client-output-buffer-limit pubsub 256mb 64mb 60
    
    #### Replication robustness ####
    # Ring buffer for partial resync (PSYNC). Larger values tolerate longer outages.
    repl-backlog-size 1gb
    
    # Keep backlog this many seconds after the last replica disconnects.
    repl-backlog-ttl 3600
    
    # I/O timeout for master/replica links (seconds) before marking broken.
    repl-timeout 120
    
    # Master pings replicas every N seconds (keepalive + lag measurement).
    repl-ping-replica-period 10
    
    # Send snapshot directly over the socket (no on-disk temp file) for full syncs.
    repl-diskless-sync yes
    
    # When diskless, wait N seconds to gather more replicas before starting bulk transfer.
    repl-diskless-sync-delay 5
    
    #### Memory optimization for small Hashes ####
    # NOTE (Redis >= 7): "hash-max-ziplist-*" are legacy aliases for listpack thresholds.
    # Prefer "hash-max-listpack-*" in new configs; these aliases still work in Redis 8.
    # Use compact encoding for hashes with <= 1024 fields...
    hash-max-ziplist-entries 1024
    
    # and when each field+value is <= 256 bytes. Larger hashes are promoted to hashtable.
    hash-max-ziplist-value 256
    
    #### Asynchronous freeing & defragmentation ####
    # Evict keys lazily in background threads (reduces main-thread pauses during eviction).
    lazyfree-lazy-eviction yes
    
    # Free expired keys asynchronously instead of during the expiry path.
    lazyfree-lazy-expire yes
    
    # Perform DEL for complex objects in background threads (non-blocking deletes).
    lazyfree-lazy-server-del yes
    
    # Actively defragment memory to combat long-running fragmentation and stabilize RSS.
    activedefrag yes
    
    #### I/O Multi-Threading ####
    # Offload read handling to I/O threads (writes remain serialized on the main thread).
    io-threads-do-reads yes
    
    # Number of I/O threads. Use a value close to available CPU cores; too high can hurt performance.
    io-threads 64

externalService:
  enabled: true
  # annotations:
  #   foo: bar
  serviceType: NodePort
  port: 6379
  nodePort: 30011

serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  # -- Namespace where servicemonitor resource will be created, if empty it will be created in the same namespace as the redis-replication
  namespace: ""
  # -- extraLabels are added to the servicemonitor when enabled set to true
  extraLabels: {}
    # foo: bar
    # team: devops

redisExporter:
  enabled: true
  image: docker.io/ruo91/opstree-redis-exporter-fedora
  tag: "v1.74.0"
  imagePullPolicy: IfNotPresent
  resources: {}
    # requests:
    #   cpu: 100m
    #   memory: 128Mi
    # limits:
    #   cpu: 100m
    #   memory: 128Mi
  env: []
    # - name: VAR_NAME
    #   value: "value1"
  securityContext: {}

initContainer:
  enabled: false
  image: ""
  imagePullPolicy: "IfNotPresent"
  resources: {}
    # requests:
    #   memory: "64Mi"
    #   cpu: "250m"
    # limits:
    #   memory: "128Mi"
    #   cpu: "500m"
  env: []
  command: []
  args: []

sidecars: []
  # - name: "redis-tools"
  #   image: "docker.io/ruo91/opstree-redis-tools-fedora:v8.0.2"
  #   imagePullPolicy: "IfNotPresent"
  #   resources:
  #     limits:
  #       cpu: "100m"
  #       memory: "128Mi"
  #     requests:
  #       cpu: "50m"
  #       memory: "64Mi"
  #   env: []
  #   # - name: MY_ENV_VAR
  #   #   value: "my-env-var-value"
  #   command: []
  #   # - "/bin/sh"
  #   # - "-c"
  #   # - "sleep 3600"

priorityClassName: ""

nodeSelector:
  node-role.kubernetes.io/worker: ""

storageSpec:
  volumeClaimTemplate:
    spec:
      storageClassName: redis-sc
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 50Gi
  #   selector: {}

podSecurityContext:
  #runAsUser: 1000
  #fsGroup: 1000
  runAsUser: 0
  fsGroup: 0
  sysctls:
  - name: net.ipv4.tcp_congestion_control
    value: "bbr"
  - name: net.core.somaxconn
    value: "1048576"
  - name: net.ipv4.tcp_max_syn_backlog
    value: "65536"
  - name: net.ipv4.ip_nonlocal_bind
    value: "1"
  - name: net.ipv4.tcp_tw_reuse
    value: "1"
  - name: net.ipv4.tcp_fin_timeout
    value: "15"
  - name: net.ipv4.tcp_keepalive_time
    value: "600"
  - name: net.ipv4.tcp_keepalive_probes
    value: "3"
  - name: net.ipv4.tcp_keepalive_intvl
    value: "15"
  - name: net.ipv4.tcp_syncookies
    value: "1"
  - name: net.ipv4.tcp_syn_retries
    value: "3"
  - name: net.ipv4.tcp_slow_start_after_idle
    value: "0"
  - name: net.ipv4.tcp_fastopen
    value: "3"
  - name: net.ipv4.tcp_sack
    value: "1"
  - name: net.ipv4.tcp_mtu_probing
    value: "1"
  - name: net.ipv4.tcp_timestamps
    value: "1"

#securityContext: {}
securityContext:
  privileged: true

#affinity: {}
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: node-role.kubernetes.io/worker
          operator: Exists
          #values:
          #- ssd

tolerations: []
#tolerations:
#  - key: "node-role.kubernetes.io/worker"
#    operator: "Exists"
#    #value: "value"
#    effect: "NoSchedule"

topologySpreadConstraints: []
  # - maxSkew: 1
  #   topologyKey: kubernetes.io/hostname
  #   whenUnsatisfiable: DoNotSchedule
  #   labelSelector:
  #     matchLabels:
  #       role: replication
  #       app: redis-replication

serviceAccountName: "default"

TLS:
  ca: ca.key
  cert: tls.crt
  key: tls.key
  secret:
    secretName: ""

acl:
  # Configure ACL from Kubernetes Secret
  secret:
    secretName: ""
  # Configure ACL from PersistentVolumeClaim
  # The PVC must contain a file named "user.acl" at root level
  # persistentVolumeClaim: "redis-acl-pvc"

env: []
  # - name: VAR_NAME
  #   value: "value1"

pdb:
  enabled: false
  minAvailable: 1
  maxUnavailable: null
